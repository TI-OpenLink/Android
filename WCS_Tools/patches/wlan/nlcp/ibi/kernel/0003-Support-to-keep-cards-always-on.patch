From f9b46c7f98c177a1f3f01974f06d26e253cb0af3 Mon Sep 17 00:00:00 2001
From: Sourav Poddar <sourav.poddar@ti.com>
Date: Thu, 2 Jun 2011 13:09:09 +0530
Subject: [PATCH 03/19] Support to keep cards always on

To keep cards always ON and to make mmc_release_host
call only once.

Signed-off-by: Sourav Poddar <sourav.poddar@ti.com>
Signed-off-by: Eliad Peller <eliad@wizery.com>
---
 drivers/mmc/host/omap_hsmmc.c |   13 +++++++++----
 1 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/mmc/host/omap_hsmmc.c b/drivers/mmc/host/omap_hsmmc.c
index 32507f5..41baec0 100644
--- a/drivers/mmc/host/omap_hsmmc.c
+++ b/drivers/mmc/host/omap_hsmmc.c
@@ -1916,8 +1916,7 @@ static void omap_hsmmc_enable_sdio_irq(struct mmc_host *mmc, int enable)
 	unsigned long flags;
 	host->inband_status = enable;
 	/*
-
-	 * When interrupts are enabled, CTPL must be set to enable
+	* When interrupts are enabled, CTPL must be set to enable
 
 	 * DAT1 input buffer (or the card interrupt is always
 	 * asserted) and FCLK must be enabled as wake-up does not
@@ -2079,7 +2078,12 @@ static int omap_hsmmc_sleep_to_off(struct omap_hsmmc_host *host)
 	      mmc_slot(host).card_detect ||
 	      (mmc_slot(host).get_cover_state &&
 	       mmc_slot(host).get_cover_state(host->dev, host->slot_id)))) {
-		mmc_release_host(host->mmc);
+		goto out;
+	}
+
+	/* Don't turn SDIO cards off. */
+	if (host->mmc->card && mmc_card_sdio(host->mmc->card)) {
+		goto out;
 	}
 	mmc_slot(host).set_power(host->dev, host->slot_id, 0, 0);
 	host->vdd = 0;
@@ -2089,7 +2093,8 @@ static int omap_hsmmc_sleep_to_off(struct omap_hsmmc_host *host)
 		host->dpm_state == CARDSLEEP ? "CARDSLEEP" : "REGSLEEP");
 
 	host->dpm_state = OFF;
-
+out:
+	mmc_release_host(host->mmc);
 	return 0;
 }
 
-- 
1.7.0.4

