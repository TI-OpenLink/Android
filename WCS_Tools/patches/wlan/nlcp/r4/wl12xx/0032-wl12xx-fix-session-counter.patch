From 9a186df69e6d3a8fa23ed053c318c9146282153f Mon Sep 17 00:00:00 2001
From: Arik Nemtsov <arik@wizery.com>
Date: Thu, 7 Apr 2011 19:49:30 +0300
Subject: [PATCH 32/75] wl12xx: fix session counter

Increment the session counter on every join command.
---
 drivers/net/wireless/wl12xx/cmd.c    |   11 ++++++++++-
 drivers/net/wireless/wl12xx/main.c   |    3 ++-
 drivers/net/wireless/wl12xx/wl12xx.h |    1 +
 3 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/wl12xx/cmd.c b/drivers/net/wireless/wl12xx/cmd.c
index b7b700f..80b86b2 100644
--- a/drivers/net/wireless/wl12xx/cmd.c
+++ b/drivers/net/wireless/wl12xx/cmd.c
@@ -456,6 +456,15 @@ void wl1271_free_link(struct wl1271 *wl, u8 *hlid)
 	*hlid = WL1271_INVALID_LINK_ID;
 }
 
+int wl1271_get_new_session_id(struct wl1271 *wl)
+{
+	wl->session_counter++;
+	if (wl->session_counter > SESSION_COUNTER_MAX)
+		wl->session_counter = SESSION_COUNTER_MIN;
+
+	return wl->session_counter;
+}
+
 int wl1271_cmd_role_start_dev(struct wl1271 *wl)
 {
 	struct wl1271_cmd_role_start *cmd;
@@ -582,7 +591,7 @@ int wl1271_cmd_role_start_sta(struct wl1271 *wl)
 			goto out_free;
 	}
 	cmd->sta.hlid = wl->sta_hlid;
-	cmd->sta.session = wl->session_counter;
+	cmd->sta.session = wl1271_get_new_session_id(wl);
 	cmd->sta.remote_rates = cpu_to_le32(wl->rate_set);
 
 	wl1271_debug(DEBUG_CMD, "role start: roleid=%d, hlid=%d, session=%d "
diff --git a/drivers/net/wireless/wl12xx/main.c b/drivers/net/wireless/wl12xx/main.c
index 356fbb4..5a42eff 100644
--- a/drivers/net/wireless/wl12xx/main.c
+++ b/drivers/net/wireless/wl12xx/main.c
@@ -1827,7 +1827,7 @@ static void __wl1271_op_remove_interface(struct wl1271 *wl,
 	wl->tx_security_last_seq = 0;
 	wl->tx_security_seq = 0;
 	wl->time_offset = 0;
-	wl->session_counter = 0;
+	wl->session_counter = SESSION_COUNTER_MIN;
 	wl->rate_set = CONF_TX_RATE_MASK_BASIC;
 	wl->vif = NULL;
 	wl->filters = 0;
@@ -4125,6 +4125,7 @@ struct ieee80211_hw *wl1271_alloc_hw(void)
 	wl->sta_hlid = WL1271_INVALID_LINK_ID;
 	wl->dev_role_id = WL1271_INVALID_ROLE_ID;
 	wl->dev_hlid = WL1271_INVALID_LINK_ID;
+	wl->session_counter = SESSION_COUNTER_MIN;
 	setup_timer(&wl->rx_streaming_timer, wl1271_rx_streaming_timer,
 		    (unsigned long) wl);
 
diff --git a/drivers/net/wireless/wl12xx/wl12xx.h b/drivers/net/wireless/wl12xx/wl12xx.h
index 8764246..857da8f 100644
--- a/drivers/net/wireless/wl12xx/wl12xx.h
+++ b/drivers/net/wireless/wl12xx/wl12xx.h
@@ -617,6 +617,7 @@ int wl1271_recalc_rx_streaming(struct wl1271 *wl);
 #define JOIN_TIMEOUT 5000 /* 5000 milliseconds to join */
 
 #define SESSION_COUNTER_MAX 7 /* maximum value for the session counter */
+#define SESSION_COUNTER_MIN 1
 
 #define WL1271_DEFAULT_POWER_LEVEL 0
 
-- 
1.7.0.4

