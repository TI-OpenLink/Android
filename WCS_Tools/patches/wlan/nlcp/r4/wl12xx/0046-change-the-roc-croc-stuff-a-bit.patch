From b4ad7319775fe7258aef102f9d1598dcedfe3964 Mon Sep 17 00:00:00 2001
From: Eliad Peller <eliad@wizery.com>
Date: Thu, 12 May 2011 13:29:18 +0300
Subject: [PATCH 46/75] change the roc/croc stuff a bit

---
 drivers/net/wireless/wl12xx/cmd.c  |   14 ++++++--------
 drivers/net/wireless/wl12xx/cmd.h  |    4 ++--
 drivers/net/wireless/wl12xx/main.c |   28 +++++++++++++++++-----------
 drivers/net/wireless/wl12xx/scan.c |    2 +-
 4 files changed, 26 insertions(+), 22 deletions(-)

diff --git a/drivers/net/wireless/wl12xx/cmd.c b/drivers/net/wireless/wl12xx/cmd.c
index 6cdb8d1..431a380 100644
--- a/drivers/net/wireless/wl12xx/cmd.c
+++ b/drivers/net/wireless/wl12xx/cmd.c
@@ -1479,11 +1479,9 @@ out:
 	return ret;
 }
 
-static int wl1271_cmd_roc(struct wl1271 *wl)
+static int wl1271_cmd_roc(struct wl1271 *wl, u8 role_id)
 {
 	struct wl1271_cmd_roc *cmd;
-	/* TODO: get role_id as param */
-	u8 role_id = wl->dev_role_id;
 	int ret = 0;
 
 	wl1271_debug(DEBUG_CMD, "cmd roc %d (%d)", wl->channel, wl->band);
@@ -1526,7 +1524,7 @@ out:
 	return ret;
 }
 
-static int wl1271_cmd_croc(struct wl1271 *wl)
+static int wl1271_cmd_croc(struct wl1271 *wl, u8 role_id)
 {
 	struct wl1271_cmd_header *cmd;
 	int ret = 0;
@@ -1553,14 +1551,14 @@ out:
 	return ret;
 }
 
-int wl1271_roc(struct wl1271 *wl)
+int wl1271_roc(struct wl1271 *wl, u8 role_id)
 {
 	int ret = 0;
 
 	if (WARN_ON(test_bit(WL1271_FLAG_ROC, &wl->flags)))
 		return 0;
 
-	ret = wl1271_cmd_roc(wl);
+	ret = wl1271_cmd_roc(wl, role_id);
 	if (ret < 0)
 		goto out;
 
@@ -1577,14 +1575,14 @@ out:
 	return ret;
 }
 
-int wl1271_croc(struct wl1271 *wl)
+int wl1271_croc(struct wl1271 *wl, u8 role_id)
 {
 	int ret = 0;
 
 	if (WARN_ON(!test_bit(WL1271_FLAG_ROC, &wl->flags)))
 		return 0;
 
-	ret = wl1271_cmd_croc(wl);
+	ret = wl1271_cmd_croc(wl, role_id);
 	if (ret < 0)
 		goto out;
 
diff --git a/drivers/net/wireless/wl12xx/cmd.h b/drivers/net/wireless/wl12xx/cmd.h
index 04e466b..7962a12 100644
--- a/drivers/net/wireless/wl12xx/cmd.h
+++ b/drivers/net/wireless/wl12xx/cmd.h
@@ -73,8 +73,8 @@ int wl1271_cmd_set_ap_key(struct wl1271 *wl, u16 action, u8 id, u8 key_type,
 			  u8 key_size, const u8 *key, u8 hlid, u32 tx_seq_32,
 			  u16 tx_seq_16);
 int wl1271_cmd_set_peer_state(struct wl1271 *wl, u8 hlid);
-int wl1271_roc(struct wl1271 *wl);
-int wl1271_croc(struct wl1271 *wl);
+int wl1271_roc(struct wl1271 *wl, u8 role_id);
+int wl1271_croc(struct wl1271 *wl, u8 role_id);
 int wl1271_cmd_add_peer(struct wl1271 *wl, struct ieee80211_sta *sta, u8 hlid);
 int wl1271_cmd_remove_peer(struct wl1271 *wl, u8 hlid);
 
diff --git a/drivers/net/wireless/wl12xx/main.c b/drivers/net/wireless/wl12xx/main.c
index ac3e45b..fbfca18 100644
--- a/drivers/net/wireless/wl12xx/main.c
+++ b/drivers/net/wireless/wl12xx/main.c
@@ -422,7 +422,7 @@ static int wl1271_dev_notify(struct notifier_block *me, unsigned long what,
 	if ((dev->operstate == IF_OPER_UP) &&
 	    !test_and_set_bit(WL1271_FLAG_STA_STATE_SENT, &wl->flags)) {
 		wl1271_cmd_set_peer_state(wl, wl->sta_hlid);
-		wl1271_croc(wl);
+		wl1271_croc(wl, wl->role_id);
 		wl1271_info("Association completed.");
 	}
 
@@ -1998,7 +1998,7 @@ static int wl1271_sta_handle_idle(struct wl1271 *wl, bool idle)
 
 	if (idle) {
 		if (test_bit(WL1271_FLAG_ROC, &wl->flags)) {
-			ret = wl1271_croc(wl);
+			ret = wl1271_croc(wl, wl->dev_role_id);
 			if (ret < 0)
 				goto out;
 
@@ -2027,7 +2027,7 @@ static int wl1271_sta_handle_idle(struct wl1271 *wl, bool idle)
 		if (ret < 0)
 			goto out;
 
-		ret = wl1271_roc(wl);
+		ret = wl1271_roc(wl, wl->dev_role_id);
 		if (ret < 0)
 			goto out;
 		clear_bit(WL1271_FLAG_IDLE, &wl->flags);
@@ -2117,11 +2117,11 @@ static int wl1271_op_config(struct ieee80211_hw *hw, u32 changed)
 				 */
 				if (test_bit(WL1271_FLAG_ROC, &wl->flags) &&
 				    !(conf->flags & IEEE80211_CONF_IDLE)) {
-					ret = wl1271_croc(wl);
+					ret = wl1271_croc(wl, wl->dev_role_id);
 					if (ret < 0)
 						goto out_sleep;
 
-					ret = wl1271_roc(wl);
+					ret = wl1271_roc(wl, wl->dev_role_id);
 					if (ret < 0)
 						wl1271_warning("roc failed %d",
 							       ret);
@@ -2589,13 +2589,18 @@ static int wl1271_op_hw_scan(struct ieee80211_hw *hw,
 		goto out;
 
 	/* cancel ROC before scanning */
-	if (test_bit(WL1271_FLAG_ROC, &wl->flags))
-		wl1271_croc(wl);
+	if (test_bit(WL1271_FLAG_ROC, &wl->flags)) {
+		if (test_bit(WL1271_FLAG_STA_ASSOCIATED, &wl->flags)) {
+			/* don't allow scanning right now (?) */
+			ret = -EBUSY;
+			goto out_sleep;
+		}
+		wl1271_croc(wl, wl->dev_role_id);
+	}
 
 	ret = wl1271_scan(hw->priv, ssid, len, req);
-
+out_sleep:
 	wl1271_ps_elp_sleep(wl);
-
 out:
 	mutex_unlock(&wl->mutex);
 
@@ -3118,12 +3123,13 @@ sta_not_found:
 				 * no IF_OPER_UP notification.
 				 */
 				if (!was_ifup) {
-					ret = wl1271_croc(wl);
+					ret = wl1271_croc(wl, wl->role_id);
 					if (ret < 0)
 						goto out;
 				}
 				wl1271_unjoin(wl);
-				wl1271_roc(wl);
+				wl1271_cmd_role_start_dev(wl);
+				wl1271_roc(wl, wl->dev_role_id);
 			}
 		}
 	}
diff --git a/drivers/net/wireless/wl12xx/scan.c b/drivers/net/wireless/wl12xx/scan.c
index 897e7c6..b357e60 100644
--- a/drivers/net/wireless/wl12xx/scan.c
+++ b/drivers/net/wireless/wl12xx/scan.c
@@ -61,7 +61,7 @@ void wl1271_scan_complete_work(struct work_struct *work)
 		wl1271_cmd_build_ap_probe_req(wl, wl->probereq);
 	} else {
 		/* restore remain on channel */
-		wl1271_roc(wl);
+		wl1271_roc(wl, wl->dev_role_id);
 	}
 	wl1271_ps_elp_sleep(wl);
 
-- 
1.7.0.4

